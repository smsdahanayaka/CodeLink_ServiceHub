// ===========================================
// CodeLink ServiceHub - Database Schema
// SaaS Customer Support & Warranty Management
// ===========================================

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===========================================
// MULTI-TENANT CORE TABLES
// ===========================================

// Subscription Plans for SaaS
model Plan {
  id                Int      @id @default(autoincrement())
  name              String   @db.VarChar(100)
  description       String?  @db.Text
  priceMonthly      Decimal  @default(0) @db.Decimal(10, 2)
  priceYearly       Decimal  @default(0) @db.Decimal(10, 2)
  maxUsers          Int?
  maxClaimsPerMonth Int?
  maxWorkflows      Int?
  maxSmsPerMonth    Int?
  features          Json?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  tenants Tenant[]

  @@map("plans")
}

// Tenants (Companies using the platform)
model Tenant {
  id           Int          @id @default(autoincrement())
  uuid         String       @unique @db.Char(36)
  name         String       @db.VarChar(255)
  subdomain    String       @unique @db.VarChar(100)
  domain       String?      @db.VarChar(255)
  logoUrl      String?      @db.VarChar(500)
  planId       Int?
  settings     Json?
  contactEmail String?      @db.VarChar(255)
  contactPhone String?      @db.VarChar(50)
  address      String?      @db.Text
  status       TenantStatus @default(TRIAL)
  trialEndsAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  plan                  Plan?                  @relation(fields: [planId], references: [id])
  roles                 Role[]
  users                 User[]
  productCategories     ProductCategory[]
  products              Product[]
  shops                 Shop[]
  customers             Customer[]
  warrantyCards         WarrantyCard[]
  warrantyClaims        WarrantyClaim[]
  workflows             Workflow[]
  collectors            Collector[]
  routes                Route[]
  pickups               Pickup[]
  deliveries            Delivery[]
  collectionTrips       CollectionTrip[]
  deliveryTrips         DeliveryTrip[]
  notificationTemplates NotificationTemplate[]
  notifications         Notification[]
  smsLogs               SmsLog[]
  emailLogs             EmailLog[]
  auditLogs             AuditLog[]
  tenantSettings        TenantSetting[]
  fileUploads           FileUpload[]
  // Phase 5 relations
  inventoryCategories   InventoryCategory[]
  inventoryItems        InventoryItem[]
  inventoryTransactions InventoryTransaction[]
  claimQuotations       ClaimQuotation[]
  claimInvoices         ClaimInvoice[]

  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL
}

// Roles (Per Tenant - Customizable)
model Role {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String   @db.VarChar(100)
  description String?  @db.Text
  permissions Json // Array of permission strings
  isSystem    Boolean  @default(false) // System roles can't be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users         User[]
  workflowSteps WorkflowStep[]

  @@unique([tenantId, name])
  @@map("roles")
}

// Users
model User {
  id              Int        @id @default(autoincrement())
  uuid            String     @unique @db.Char(36)
  tenantId        Int
  roleId          Int
  email           String     @db.VarChar(255)
  passwordHash    String     @db.VarChar(255)
  firstName       String?    @db.VarChar(100)
  lastName        String?    @db.VarChar(100)
  phone           String?    @db.VarChar(50)
  avatarUrl       String?    @db.VarChar(500)
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime?
  status          UserStatus @default(ACTIVE)
  preferences     Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  tenant                  Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role                    Role                   @relation(fields: [roleId], references: [id])
  sessions                UserSession[]
  createdWarrantyCards    WarrantyCard[]         @relation("CreatedByUser")
  createdClaims           WarrantyClaim[]        @relation("CreatedByUser")
  assignedClaims          WarrantyClaim[]        @relation("AssignedToUser")
  claimHistory            ClaimHistory[]
  createdWorkflows        Workflow[]
  autoAssignSteps         WorkflowStep[]
  collector               Collector?
  notifications           Notification[]
  auditLogs               AuditLog[]
  fileUploads             FileUpload[]
  // Step assignment relations
  stepAssignments         ClaimStepAssignment[]  @relation("StepAssignedUser")
  stepAssignmentsMade     ClaimStepAssignment[]  @relation("StepAssignedBy")
  // Sub-task relations
  assignedSubTasks        ClaimSubTask[]         @relation("SubTaskAssignee")
  completedSubTasks       ClaimSubTask[]         @relation("SubTaskCompletedBy")
  createdSubTasks         ClaimSubTask[]         @relation("SubTaskCreatedBy")
  // Trip relations
  receivedCollectionTrips CollectionTrip[]       @relation("CollectionTripReceiver")
  createdDeliveryTrips    DeliveryTrip[]         @relation("DeliveryTripCreator")
  // Phase 5 relations
  inventoryTransactions   InventoryTransaction[]
  createdQuotations       ClaimQuotation[]
  createdInvoices         ClaimInvoice[]
  claimPartsIssued        ClaimPart[]            @relation("ClaimPartIssuedBy")
  claimPartsCreated       ClaimPart[]            @relation("ClaimPartCreatedBy")
  claimServiceCharges     ClaimServiceCharge[]
  warrantyOverrides       WarrantyClaim[]        @relation("WarrantyOverrideBy")
  acceptedClaims          WarrantyClaim[]        @relation("ClaimAcceptedBy")

  @@unique([tenantId, email])
  @@index([tenantId, status])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// User Sessions
model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int
  sessionToken String   @unique @db.VarChar(255)
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.Text
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// ===========================================
// BUSINESS ENTITIES
// ===========================================

// Product Categories
model ProductCategory {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String   @db.VarChar(255)
  description String?  @db.Text
  parentId    Int?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

// Products
model Product {
  id                   Int      @id @default(autoincrement())
  tenantId             Int
  categoryId           Int?
  name                 String   @db.VarChar(255)
  modelNumber          String?  @db.VarChar(100)
  sku                  String?  @db.VarChar(100)
  description          String?  @db.Text
  specifications       Json?
  warrantyPeriodMonths Int      @default(12)
  serialNumberPrefix   String?  @db.VarChar(50)
  imageUrl             String?  @db.VarChar(500)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category        ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  warrantyCards   WarrantyCard[]
  collectionItems CollectionItem[]

  @@map("products")
}

// Shops/Dealers
model Shop {
  id            Int        @id @default(autoincrement())
  tenantId      Int
  code          String?    @db.VarChar(50)
  name          String     @db.VarChar(255)
  email         String?    @db.VarChar(255)
  phone         String?    @db.VarChar(50)
  address       String?    @db.Text
  city          String?    @db.VarChar(100)
  state         String?    @db.VarChar(100)
  postalCode    String?    @db.VarChar(20)
  country       String     @default("India") @db.VarChar(100)
  contactPerson String?    @db.VarChar(255)
  contactPhone  String?    @db.VarChar(50)
  gstNumber     String?    @db.VarChar(50)
  status        ShopStatus @default(ACTIVE)
  isVerified    Boolean    @default(false) // false = pending admin verification
  notes         String?    @db.Text
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customers       Customer[]
  warrantyCards   WarrantyCard[]
  pickups         Pickup[]
  deliveries      Delivery[]
  collectionTrips CollectionTrip[]
  collectionItems CollectionItem[]
  deliveryTrips   DeliveryTrip[]

  @@index([isVerified])
  @@map("shops")
}

enum ShopStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Customers
model Customer {
  id             Int      @id @default(autoincrement())
  tenantId       Int
  shopId         Int?
  name           String   @db.VarChar(255)
  email          String?  @db.VarChar(255)
  phone          String   @db.VarChar(50)
  alternatePhone String?  @db.VarChar(50)
  address        String?  @db.Text
  city           String?  @db.VarChar(100)
  state          String?  @db.VarChar(100)
  postalCode     String?  @db.VarChar(20)
  country        String   @default("India") @db.VarChar(100)
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shop          Shop?          @relation(fields: [shopId], references: [id], onDelete: SetNull)
  warrantyCards WarrantyCard[]

  @@map("customers")
}

// ===========================================
// WARRANTY MANAGEMENT
// ===========================================

// Warranty Cards
model WarrantyCard {
  id                     Int                @id @default(autoincrement())
  tenantId               Int
  cardNumber             String             @db.VarChar(100)
  productId              Int
  customerId             Int? // Optional - shops/dealers are primary contact
  shopId                 Int // Required - shop must exist (can be unverified)
  serialNumber           String             @db.VarChar(100)
  purchaseDate           DateTime           @db.Date
  warrantyStartDate      DateTime           @db.Date
  warrantyEndDate        DateTime           @db.Date
  invoiceNumber          String?            @db.VarChar(100)
  invoiceAmount          Decimal?           @db.Decimal(12, 2)
  extendedWarrantyMonths Int                @default(0)
  status                 WarrantyCardStatus @default(ACTIVE)
  notes                  String?            @db.Text
  attachments            Json?
  createdBy              Int?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product         Product          @relation(fields: [productId], references: [id])
  customer        Customer?        @relation(fields: [customerId], references: [id])
  shop            Shop             @relation(fields: [shopId], references: [id])
  createdByUser   User?            @relation("CreatedByUser", fields: [createdBy], references: [id])
  warrantyClaims  WarrantyClaim[]
  collectionItems CollectionItem[]
  pickups         Pickup[]

  @@unique([tenantId, cardNumber])
  @@unique([tenantId, serialNumber])
  @@index([tenantId, status])
  @@map("warranty_cards")
}

enum WarrantyCardStatus {
  ACTIVE
  EXPIRED
  VOID
  CLAIMED
}

// Warranty Claims
model WarrantyClaim {
  id                   Int           @id @default(autoincrement())
  tenantId             Int
  claimNumber          String        @db.VarChar(100)
  warrantyCardId       Int
  workflowId           Int?
  currentStepId        Int?
  currentStepStartedAt DateTime?
  issueDescription     String        @db.Text
  issueCategory        String?       @db.VarChar(100)
  reportedBy           ReportedBy    @default(SHOP)
  priority             ClaimPriority @default(MEDIUM)
  currentStatus        String        @default("new") @db.VarChar(100)
  currentLocation      ClaimLocation @default(SHOP)
  assignedTo           Int?
  diagnosis            String?       @db.Text
  resolution           String?       @db.Text
  partsUsed            Json?
  repairCost           Decimal       @default(0) @db.Decimal(12, 2)
  isWarrantyVoid       Boolean       @default(false)
  voidReason           String?       @db.Text
  // Due date tracking
  dueDate              DateTime?
  dueDateSource        String?       @db.VarChar(50) // "sla", "manual", "priority"
  receivedAt           DateTime?
  resolvedAt           DateTime?
  createdBy            Int?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Phase 5: Warranty validation fields
  isUnderWarranty        Boolean   @default(true)
  warrantyOverrideBy     Int?
  warrantyOverrideAt     DateTime?
  warrantyOverrideReason String?   @db.Text
  requiresQuotation      Boolean   @default(false)
  quotationApprovedAt    DateTime?

  // Acceptance workflow (for items from collection trips)
  acceptanceStatus ClaimAcceptanceStatus @default(ACCEPTED)
  acceptedAt       DateTime?
  acceptedBy       Int?

  // Relations
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warrantyCard         WarrantyCard          @relation(fields: [warrantyCardId], references: [id])
  workflow             Workflow?             @relation(fields: [workflowId], references: [id])
  currentStep          WorkflowStep?         @relation(fields: [currentStepId], references: [id])
  assignedUser         User?                 @relation("AssignedToUser", fields: [assignedTo], references: [id])
  createdByUser        User?                 @relation("CreatedByUser", fields: [createdBy], references: [id])
  warrantyOverrideUser User?                 @relation("WarrantyOverrideBy", fields: [warrantyOverrideBy], references: [id])
  acceptedByUser       User?                 @relation("ClaimAcceptedBy", fields: [acceptedBy], references: [id])
  claimHistory         ClaimHistory[]
  pickups              Pickup[]
  deliveries           Delivery[]
  stepAssignments      ClaimStepAssignment[]
  subTasks             ClaimSubTask[]
  collectionItem       CollectionItem?
  deliveryItems        DeliveryItem[]
  // Phase 5 relations
  quotations           ClaimQuotation[]
  invoice              ClaimInvoice?
  parts                ClaimPart[]
  serviceCharges       ClaimServiceCharge[]

  @@unique([tenantId, claimNumber])
  @@index([tenantId, currentStatus])
  @@index([assignedTo])
  @@map("warranty_claims")
}

enum ReportedBy {
  CUSTOMER
  SHOP
  INTERNAL
}

enum ClaimPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ClaimLocation {
  CUSTOMER
  SHOP
  IN_TRANSIT
  SERVICE_CENTER
}

enum ClaimAcceptanceStatus {
  PENDING // Just received from collection, needs review
  ACCEPTED // Accepted, ready for workflow
  REJECTED // Rejected (to be returned)
}

// Claim Step Assignments (Per-claim user mapping to workflow steps)
model ClaimStepAssignment {
  id             Int      @id @default(autoincrement())
  claimId        Int
  workflowStepId Int
  assignedUserId Int
  assignedBy     Int
  notes          String?  @db.Text
  isActive       Boolean  @default(true)

  // Step status tracking (detailed status for workflow)
  stepStatus      StepStatus @default(NOT_STARTED)
  stepStartedAt   DateTime?
  stepCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claim          WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  workflowStep   WorkflowStep  @relation(fields: [workflowStepId], references: [id], onDelete: Cascade)
  assignedUser   User          @relation("StepAssignedUser", fields: [assignedUserId], references: [id])
  assignedByUser User          @relation("StepAssignedBy", fields: [assignedBy], references: [id])

  @@unique([claimId, workflowStepId])
  @@index([claimId])
  @@index([assignedUserId])
  @@map("claim_step_assignments")
}

// Claim Sub-Tasks (Tasks within a workflow step)
model ClaimSubTask {
  id             Int             @id @default(autoincrement())
  claimId        Int
  workflowStepId Int
  title          String          @db.VarChar(255)
  description    String?         @db.Text
  assignedTo     Int?
  status         SubTaskStatus   @default(PENDING)
  priority       SubTaskPriority @default(MEDIUM)
  dueDate        DateTime?
  completedAt    DateTime?
  completedBy    Int?
  createdBy      Int
  sortOrder      Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  workflowStep    WorkflowStep  @relation(fields: [workflowStepId], references: [id], onDelete: Cascade)
  assignedUser    User?         @relation("SubTaskAssignee", fields: [assignedTo], references: [id])
  completedByUser User?         @relation("SubTaskCompletedBy", fields: [completedBy], references: [id])
  createdByUser   User          @relation("SubTaskCreatedBy", fields: [createdBy], references: [id])

  @@index([claimId, workflowStepId])
  @@index([assignedTo, status])
  @@map("claim_sub_tasks")
}

enum SubTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SubTaskPriority {
  LOW
  MEDIUM
  HIGH
}

// Step Status for ClaimStepAssignment (detailed tracking)
enum StepStatus {
  NOT_STARTED
  STARTED
  IN_PROGRESS
  WAITING_FOR_PARTS
  WAITING_FOR_APPROVAL
  ON_HOLD
  COMPLETED
}

// Claim History (Audit Trail)
model ClaimHistory {
  id             Int      @id @default(autoincrement())
  claimId        Int
  workflowStepId Int?
  fromStatus     String?  @db.VarChar(100)
  toStatus       String   @db.VarChar(100)
  fromLocation   String?  @db.VarChar(100)
  toLocation     String?  @db.VarChar(100)
  actionType     String   @db.VarChar(100)
  performedBy    Int
  notes          String?  @db.Text
  attachments    Json?
  metadata       Json?
  createdAt      DateTime @default(now())

  // Relations
  claim         WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  workflowStep  WorkflowStep? @relation(fields: [workflowStepId], references: [id])
  performedUser User          @relation(fields: [performedBy], references: [id])

  @@index([claimId, createdAt])
  @@map("claim_history")
}

// ===========================================
// WORKFLOW ENGINE
// ===========================================

// Workflows (Process Templates)
model Workflow {
  id                Int                 @id @default(autoincrement())
  tenantId          Int
  name              String              @db.VarChar(255)
  description       String?             @db.Text
  triggerType       WorkflowTriggerType @default(AUTO_ON_CLAIM)
  triggerConditions Json?
  isDefault         Boolean             @default(false)
  isActive          Boolean             @default(true)
  version           Int                 @default(1)
  createdBy         Int?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser  User?           @relation(fields: [createdBy], references: [id])
  steps          WorkflowStep[]
  warrantyClaims WarrantyClaim[]

  @@map("workflows")
}

enum WorkflowTriggerType {
  MANUAL
  AUTO_ON_CLAIM
  CONDITIONAL
}

// Workflow Steps
model WorkflowStep {
  id                       Int      @id @default(autoincrement())
  workflowId               Int
  name                     String   @db.VarChar(255)
  description              String?  @db.Text
  stepOrder                Int
  stepType                 StepType @default(ACTION)
  statusName               String   @db.VarChar(100)
  config                   Json?
  requiredRoleId           Int?                          // Deprecated: Use allowedRoleIds instead
  allowedRoleIds           Json?                          // Array of role IDs: [1,2,3] or null/[] = all users
  allowedUserIds           Json?                          // Array of user IDs: [1,2,3] or null/[] = based on roles
  assignmentType           String?  @db.VarChar(20)       // "ALL" | "ROLES" | "USERS" - default ALL
  requiredPermissions      Json?
  slaHours                 Int?
  slaWarningHours          Int?
  autoAssignTo             Int?                          // Deprecated: Use allowedUserIds instead
  formFields               Json?
  isOptional               Boolean  @default(false)
  canSkip                  Boolean  @default(false)
  requireNextUserSelection Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  workflow          Workflow              @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  requiredRole      Role?                 @relation(fields: [requiredRoleId], references: [id])
  autoAssignUser    User?                 @relation(fields: [autoAssignTo], references: [id])
  transitionsFrom   StepTransition[]      @relation("FromStep")
  transitionsTo     StepTransition[]      @relation("ToStep")
  stepNotifications StepNotification[]
  claimHistory      ClaimHistory[]
  currentClaims     WarrantyClaim[]
  claimAssignments  ClaimStepAssignment[]
  subTasks          ClaimSubTask[]

  @@map("workflow_steps")
}

enum StepType {
  START
  ACTION
  DECISION
  NOTIFICATION
  WAIT
  END
}

// Step Transitions
model StepTransition {
  id             Int                     @id @default(autoincrement())
  fromStepId     Int
  toStepId       Int
  transitionName String?                 @db.VarChar(100)
  conditionType  TransitionConditionType @default(ALWAYS)
  conditions     Json?
  priority       Int                     @default(0)
  createdAt      DateTime                @default(now())

  // Relations
  fromStep WorkflowStep @relation("FromStep", fields: [fromStepId], references: [id], onDelete: Cascade)
  toStep   WorkflowStep @relation("ToStep", fields: [toStepId], references: [id], onDelete: Cascade)

  @@map("step_transitions")
}

enum TransitionConditionType {
  ALWAYS
  CONDITIONAL
  USER_CHOICE
}

// Step Notifications
model StepNotification {
  id                     Int                      @id @default(autoincrement())
  stepId                 Int
  notificationTemplateId Int
  triggerEvent           NotificationTriggerEvent @default(ON_ENTER)
  recipientType          RecipientType
  recipientRoleId        Int?
  recipientUserId        Int?
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())

  // Relations
  step                 WorkflowStep         @relation(fields: [stepId], references: [id], onDelete: Cascade)
  notificationTemplate NotificationTemplate @relation(fields: [notificationTemplateId], references: [id])

  @@map("step_notifications")
}

enum NotificationTriggerEvent {
  ON_ENTER
  ON_EXIT
  ON_SLA_WARNING
  ON_SLA_BREACH
}

enum RecipientType {
  CUSTOMER
  SHOP
  ASSIGNED_USER
  ROLE
  SPECIFIC_USER
}

// ===========================================
// LOGISTICS & TRACKING
// ===========================================

// Route Master (For organizing pickup/delivery areas)
model Route {
  id          Int         @id @default(autoincrement())
  tenantId    Int
  name        String      @db.VarChar(255)
  zone        String?     @db.VarChar(255) // Zone/Region name
  areas       String?     @db.Text // Covered areas (comma-separated or description)
  description String?     @db.Text
  status      RouteStatus @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pickups Pickup[]

  @@unique([tenantId, name])
  @@map("routes")
}

enum RouteStatus {
  ACTIVE
  INACTIVE
}

// Collectors (Logistics Personnel)
model Collector {
  id            Int             @id @default(autoincrement())
  tenantId      Int
  userId        Int?            @unique
  name          String          @db.VarChar(255)
  phone         String          @db.VarChar(50)
  email         String?         @db.VarChar(255)
  vehicleNumber String?         @db.VarChar(50)
  vehicleType   String?         @db.VarChar(100)
  assignedAreas Json?
  status        CollectorStatus @default(ACTIVE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User?            @relation(fields: [userId], references: [id])
  pickups         Pickup[]
  deliveries      Delivery[]
  collectionTrips CollectionTrip[]
  deliveryTrips   DeliveryTrip[]

  @@map("collectors")
}

enum CollectorStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

// Pickups (Shop to Service Center)
model Pickup {
  id                Int            @id @default(autoincrement())
  tenantId          Int
  claimId           Int? // Optional - items added later by collector
  warrantyCardId    Int? // Direct link to warranty card
  collectorId       Int?
  routeId           Int? // Link to Route master
  pickupNumber      String?        @db.VarChar(100)
  routeArea         String?        @db.VarChar(255) // Legacy field - use routeId instead
  fromType          PickupFromType @default(SHOP)
  fromShopId        Int?
  fromAddress       String?        @db.Text
  toLocation        String         @default("Service Center") @db.VarChar(255)
  scheduledDate     DateTime?      @db.Date
  scheduledTimeSlot String?        @db.VarChar(50)
  status            PickupStatus   @default(PENDING)
  pickedAt          DateTime?
  receivedAt        DateTime?
  receiverName      String?        @db.VarChar(255)
  notes             String?        @db.Text
  // Rejection tracking
  rejectedAt        DateTime?
  rejectedBy        Int?
  rejectionReason   String?        @db.Text
  // Customer info for easy access (especially for CUSTOMER pickup type)
  customerName      String?        @db.VarChar(255)
  customerPhone     String?        @db.VarChar(50)
  customerAddress   String?        @db.Text
  // Link to collection trip when pickup is started
  collectionTripId  Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim           WarrantyClaim?   @relation(fields: [claimId], references: [id])
  warrantyCard    WarrantyCard?    @relation(fields: [warrantyCardId], references: [id])
  collector       Collector?       @relation(fields: [collectorId], references: [id])
  route           Route?           @relation(fields: [routeId], references: [id])
  fromShop        Shop?            @relation(fields: [fromShopId], references: [id])
  collectionTrip  CollectionTrip?  @relation(fields: [collectionTripId], references: [id])
  collectionItems CollectionItem[] // Items collected for this pickup

  @@index([tenantId, status])
  @@index([warrantyCardId])
  @@index([collectionTripId])
  @@index([routeId])
  @@map("pickups")
}

enum PickupFromType {
  SHOP
  CUSTOMER
}

enum PickupStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
  REJECTED // Rejected after inspection - ready for return delivery
}

// Deliveries (Service Center to Shop/Customer)
model Delivery {
  id                Int            @id @default(autoincrement())
  tenantId          Int
  claimId           Int
  collectorId       Int?
  deliveryNumber    String?        @db.VarChar(100)
  fromLocation      String         @default("Service Center") @db.VarChar(255)
  toType            DeliveryToType @default(SHOP)
  toShopId          Int?
  toAddress         String?        @db.Text
  scheduledDate     DateTime?      @db.Date
  scheduledTimeSlot String?        @db.VarChar(50)
  status            DeliveryStatus @default(PENDING)
  dispatchedAt      DateTime?
  deliveredAt       DateTime?
  recipientName     String?        @db.VarChar(255)
  signatureUrl      String?        @db.VarChar(500)
  deliveryProofUrl  String?        @db.VarChar(500)
  failureReason     String?        @db.Text
  notes             String?        @db.Text
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim     WarrantyClaim @relation(fields: [claimId], references: [id])
  collector Collector?    @relation(fields: [collectorId], references: [id])
  toShop    Shop?         @relation(fields: [toShopId], references: [id])

  @@index([tenantId, status])
  @@map("deliveries")
}

enum DeliveryToType {
  SHOP
  CUSTOMER
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
  FAILED
}

// ===========================================
// TRIP-BASED LOGISTICS (Phase 4)
// ===========================================

// Collection Trip - Groups multiple items picked up together
model CollectionTrip {
  id              Int                  @id @default(autoincrement())
  tenantId        Int
  tripNumber      String               @db.VarChar(100)
  collectorId     Int
  fromType        TripFromType         @default(SHOP)
  shopId          Int?
  customerName    String?              @db.VarChar(255)
  customerPhone   String?              @db.VarChar(50)
  customerAddress String?              @db.Text
  status          CollectionTripStatus @default(IN_PROGRESS)
  startedAt       DateTime             @default(now())
  completedAt     DateTime?
  receivedAt      DateTime?
  receivedBy      Int?
  notes           String?              @db.Text
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  collector    Collector        @relation(fields: [collectorId], references: [id])
  shop         Shop?            @relation(fields: [shopId], references: [id])
  receiverUser User?            @relation("CollectionTripReceiver", fields: [receivedBy], references: [id])
  items        CollectionItem[]
  pickups      Pickup[] // Scheduled pickups linked to this trip

  @@unique([tenantId, tripNumber])
  @@index([tenantId, status])
  @@index([collectorId])
  @@map("collection_trips")
}

enum TripFromType {
  SHOP
  CUSTOMER
}

enum CollectionTripStatus {
  IN_PROGRESS
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

// Collection Item - Individual item in a collection trip
model CollectionItem {
  id               Int                  @id @default(autoincrement())
  tripId           Int
  shopId           Int? // Shop this item was collected from
  pickupId         Int? // Linked scheduled pickup (if any)
  serialNumber     String               @db.VarChar(100)
  issueDescription String               @db.Text
  warrantyCardId   Int?
  productId        Int?
  customerName     String?              @db.VarChar(255)
  customerPhone    String?              @db.VarChar(50)
  customerAddress  String?              @db.Text
  claimId          Int?                 @unique
  status           CollectionItemStatus @default(COLLECTED)
  notes            String?              @db.Text
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Relations
  trip         CollectionTrip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  shop         Shop?          @relation(fields: [shopId], references: [id])
  pickup       Pickup?        @relation(fields: [pickupId], references: [id])
  warrantyCard WarrantyCard?  @relation(fields: [warrantyCardId], references: [id])
  product      Product?       @relation(fields: [productId], references: [id])
  claim        WarrantyClaim? @relation(fields: [claimId], references: [id])

  @@index([tripId])
  @@index([shopId])
  @@map("collection_items")
}

enum CollectionItemStatus {
  COLLECTED
  RECEIVED
  PROCESSED
  REJECTED
}

// Delivery Trip - Groups multiple deliveries going to same destination
model DeliveryTrip {
  id              Int                @id @default(autoincrement())
  tenantId        Int
  tripNumber      String             @db.VarChar(100)
  collectorId     Int?
  toType          TripToType         @default(SHOP)
  shopId          Int?
  customerName    String?            @db.VarChar(255)
  customerPhone   String?            @db.VarChar(50)
  customerAddress String?            @db.Text
  status          DeliveryTripStatus @default(PENDING)
  scheduledDate   DateTime?          @db.Date
  scheduledSlot   String?            @db.VarChar(50)
  dispatchedAt    DateTime?
  completedAt     DateTime?
  recipientName   String?            @db.VarChar(255)
  signatureUrl    String?            @db.VarChar(500)
  notes           String?            @db.Text
  createdBy       Int?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  collector   Collector?     @relation(fields: [collectorId], references: [id])
  shop        Shop?          @relation(fields: [shopId], references: [id])
  createdUser User?          @relation("DeliveryTripCreator", fields: [createdBy], references: [id])
  items       DeliveryItem[]

  @@unique([tenantId, tripNumber])
  @@index([tenantId, status])
  @@index([collectorId])
  @@map("delivery_trips")
}

enum TripToType {
  SHOP
  CUSTOMER
}

enum DeliveryTripStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  PARTIAL
  CANCELLED
}

// Delivery Item - Individual item in a delivery trip
model DeliveryItem {
  id            Int                @id @default(autoincrement())
  tripId        Int
  claimId       Int
  status        DeliveryItemStatus @default(PENDING)
  failureReason String?            @db.Text
  deliveredAt   DateTime?
  notes         String?            @db.Text
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  // Relations
  trip  DeliveryTrip  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  claim WarrantyClaim @relation(fields: [claimId], references: [id])

  @@index([tripId])
  @@index([claimId])
  @@map("delivery_items")
}

enum DeliveryItemStatus {
  PENDING
  DELIVERED
  FAILED
}

// ===========================================
// NOTIFICATIONS
// ===========================================

// Notification Templates
model NotificationTemplate {
  id           Int              @id @default(autoincrement())
  tenantId     Int
  name         String           @db.VarChar(255)
  type         NotificationType
  subject      String?          @db.VarChar(500)
  bodyTemplate String           @db.Text
  variables    Json?
  triggerEvent String?          @db.VarChar(100)
  isSystem     Boolean          @default(false)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stepNotifications StepNotification[]
  smsLogs           SmsLog[]
  emailLogs         EmailLog[]

  @@map("notification_templates")
}

enum NotificationType {
  SMS
  EMAIL
  IN_APP
  PUSH
}

// In-App Notifications
model Notification {
  id        Int       @id @default(autoincrement())
  tenantId  Int
  userId    Int
  type      String    @db.VarChar(100)
  title     String    @db.VarChar(255)
  message   String    @db.Text
  link      String?   @db.VarChar(500)
  data      Json?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// SMS Logs
model SmsLog {
  id                Int       @id @default(autoincrement())
  tenantId          Int
  templateId        Int?
  phoneNumber       String    @db.VarChar(50)
  message           String    @db.Text
  variables         Json?
  provider          String?   @db.VarChar(100)
  providerMessageId String?   @db.VarChar(255)
  status            SmsStatus @default(PENDING)
  errorMessage      String?   @db.Text
  cost              Decimal?  @db.Decimal(8, 4)
  sentAt            DateTime?
  deliveredAt       DateTime?
  createdAt         DateTime  @default(now())

  // Relations
  tenant   Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template NotificationTemplate? @relation(fields: [templateId], references: [id])

  @@index([tenantId, status])
  @@map("sms_logs")
}

enum SmsStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

// Email Logs
model EmailLog {
  id                Int         @id @default(autoincrement())
  tenantId          Int
  templateId        Int?
  toEmail           String      @db.VarChar(255)
  ccEmails          Json?
  subject           String      @db.VarChar(500)
  body              String      @db.Text
  attachments       Json?
  provider          String?     @db.VarChar(100)
  providerMessageId String?     @db.VarChar(255)
  status            EmailStatus @default(PENDING)
  errorMessage      String?     @db.Text
  openedAt          DateTime?
  sentAt            DateTime?
  createdAt         DateTime    @default(now())

  // Relations
  tenant   Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template NotificationTemplate? @relation(fields: [templateId], references: [id])

  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

// ===========================================
// SYSTEM & AUDIT
// ===========================================

// Audit Logs
model AuditLog {
  id         BigInt   @id @default(autoincrement())
  tenantId   Int?
  userId     Int?
  action     String   @db.VarChar(100)
  entityType String   @db.VarChar(100)
  entityId   Int?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text
  createdAt  DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// System Settings (Global)
model SystemSetting {
  id          Int         @id @default(autoincrement())
  keyName     String      @unique @db.VarChar(100)
  value       String?     @db.Text
  type        SettingType @default(STRING)
  description String?     @db.Text
  isPublic    Boolean     @default(false)
  updatedAt   DateTime    @updatedAt

  @@map("system_settings")
}

// Tenant Settings
model TenantSetting {
  id        Int         @id @default(autoincrement())
  tenantId  Int
  keyName   String      @db.VarChar(100)
  value     String?     @db.Text
  type      SettingType @default(STRING)
  updatedAt DateTime    @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, keyName])
  @@map("tenant_settings")
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// File Uploads
model FileUpload {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  uploadedBy   Int?
  originalName String   @db.VarChar(255)
  storedName   String   @db.VarChar(255)
  filePath     String   @db.VarChar(500)
  fileType     String?  @db.VarChar(100)
  fileSize     Int?
  mimeType     String?  @db.VarChar(100)
  entityType   String?  @db.VarChar(100)
  entityId     Int?
  isPublic     Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Relations
  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedUser User?  @relation(fields: [uploadedBy], references: [id])

  @@map("file_uploads")
}

// ===========================================
// INVENTORY MANAGEMENT (Phase 5)
// ===========================================

// Inventory Item Categories
model InventoryCategory {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String   @db.VarChar(255)
  description String?  @db.Text
  parentId    Int?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   InventoryCategory?  @relation("InventoryCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children InventoryCategory[] @relation("InventoryCategoryHierarchy")
  items    InventoryItem[]

  @@map("inventory_categories")
}

// Inventory Items (Parts/Components/Spare Parts)
model InventoryItem {
  id         Int  @id @default(autoincrement())
  tenantId   Int
  categoryId Int?

  sku         String  @db.VarChar(100)
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Stock management
  quantity         Decimal @default(0) @db.Decimal(10, 2)
  reservedQuantity Decimal @default(0) @db.Decimal(10, 2)
  reorderLevel     Decimal @default(0) @db.Decimal(10, 2)
  reorderQuantity  Decimal @default(0) @db.Decimal(10, 2)

  // Pricing
  costPrice    Decimal @default(0) @db.Decimal(12, 2)
  sellingPrice Decimal @default(0) @db.Decimal(12, 2)

  // Additional info
  unit     String  @default("pcs") @db.VarChar(50)
  location String? @db.VarChar(255)
  supplier String? @db.VarChar(255)
  barcode  String? @db.VarChar(100)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant         Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category       InventoryCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  transactions   InventoryTransaction[]
  quotationItems QuotationItem[]
  claimParts     ClaimPart[]

  @@unique([tenantId, sku])
  @@index([tenantId, isActive])
  @@map("inventory_items")
}

// Inventory Transactions (Stock movements)
model InventoryTransaction {
  id       Int @id @default(autoincrement())
  tenantId Int
  itemId   Int

  transactionType InventoryTransactionType
  quantity        Decimal                  @db.Decimal(10, 2)

  // Reference to source document
  referenceType String? @db.VarChar(50)
  referenceId   Int?

  // Pricing at time of transaction
  unitCost  Decimal? @db.Decimal(12, 2)
  totalCost Decimal? @db.Decimal(12, 2)

  // Stock levels after transaction
  previousQuantity Decimal @db.Decimal(10, 2)
  newQuantity      Decimal @db.Decimal(10, 2)

  notes     String?  @db.Text
  createdBy Int
  createdAt DateTime @default(now())

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item          InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  createdByUser User          @relation(fields: [createdBy], references: [id])

  @@index([tenantId, itemId])
  @@index([referenceType, referenceId])
  @@map("inventory_transactions")
}

enum InventoryTransactionType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  RESERVED
  UNRESERVED
  RETURN
}

// ===========================================
// QUOTATION SYSTEM (Phase 5)
// ===========================================

// Quotation for repair cost estimation
model ClaimQuotation {
  id       Int @id @default(autoincrement())
  tenantId Int
  claimId  Int

  quotationNumber String @db.VarChar(100)

  status QuotationStatus @default(DRAFT)

  // Amounts
  subtotal       Decimal       @db.Decimal(12, 2)
  taxRate        Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount      Decimal       @default(0) @db.Decimal(12, 2)
  discountType   DiscountType?
  discountValue  Decimal       @default(0) @db.Decimal(12, 2)
  discountAmount Decimal       @default(0) @db.Decimal(12, 2)
  totalAmount    Decimal       @db.Decimal(12, 2)

  // Validity
  validUntil DateTime?

  // Customer response tracking
  sentAt          DateTime?
  sentVia         String?   @db.VarChar(50)
  viewedAt        DateTime?
  approvedAt      DateTime?
  approvedBy      String?   @db.VarChar(255)
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  notes              String? @db.Text
  termsAndConditions String? @db.Text

  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim         WarrantyClaim   @relation(fields: [claimId], references: [id], onDelete: Cascade)
  createdByUser User            @relation(fields: [createdBy], references: [id])
  items         QuotationItem[]
  invoice       ClaimInvoice?

  @@unique([tenantId, quotationNumber])
  @@index([claimId])
  @@map("claim_quotations")
}

enum QuotationStatus {
  DRAFT
  SENT
  VIEWED
  APPROVED
  REJECTED
  EXPIRED
  CONVERTED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// Individual items in quotation
model QuotationItem {
  id          Int @id @default(autoincrement())
  quotationId Int

  itemType QuotationItemType

  // For inventory items
  inventoryItemId Int?

  // Item details
  name        String  @db.VarChar(255)
  description String? @db.Text
  sku         String? @db.VarChar(100)

  quantity   Decimal @db.Decimal(10, 2)
  unitPrice  Decimal @db.Decimal(12, 2)
  totalPrice Decimal @db.Decimal(12, 2)

  isWarrantyCovered Boolean @default(false)
  warrantyNotes     String? @db.Text

  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  quotation     ClaimQuotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)

  @@index([quotationId])
  @@map("quotation_items")
}

enum QuotationItemType {
  PART
  SERVICE
  LABOR
  OTHER
}

// ===========================================
// CLAIM PARTS & SERVICE CHARGES (Phase 5)
// ===========================================

// Parts/Items used in claim repair
model ClaimPart {
  id      Int @id @default(autoincrement())
  claimId Int

  partType ClaimPartType @default(INVENTORY)

  // For inventory items
  inventoryItemId Int?

  // Part details
  name        String  @db.VarChar(255)
  description String? @db.Text
  sku         String? @db.VarChar(100)

  quantity   Decimal @db.Decimal(10, 2)
  unitCost   Decimal @default(0) @db.Decimal(12, 2)
  unitPrice  Decimal @db.Decimal(12, 2)
  totalPrice Decimal @db.Decimal(12, 2)

  // Warranty coverage
  isWarrantyCovered Boolean @default(false)

  // Issue tracking (for new items being given to customer)
  isNewItemIssue Boolean   @default(false)
  isIssued       Boolean   @default(false)
  issuedAt       DateTime?
  issuedBy       Int?

  notes     String?  @db.Text
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claim         WarrantyClaim  @relation(fields: [claimId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  issuedByUser  User?          @relation("ClaimPartIssuedBy", fields: [issuedBy], references: [id])
  createdByUser User           @relation("ClaimPartCreatedBy", fields: [createdBy], references: [id])
  invoiceItems  InvoiceItem[]

  @@index([claimId])
  @@map("claim_parts")
}

enum ClaimPartType {
  INVENTORY
  MANUAL
}

// Service charges for claim
model ClaimServiceCharge {
  id      Int @id @default(autoincrement())
  claimId Int

  chargeType  ServiceChargeType
  description String            @db.VarChar(255)
  amount      Decimal           @db.Decimal(12, 2)

  isWarrantyCovered Boolean @default(false)

  notes     String?  @db.Text
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claim         WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  createdByUser User          @relation(fields: [createdBy], references: [id])
  invoiceItems  InvoiceItem[]

  @@index([claimId])
  @@map("claim_service_charges")
}

enum ServiceChargeType {
  LABOR
  SERVICE_VISIT
  TRANSPORTATION
  DIAGNOSIS
  INSTALLATION
  OTHER
}

// ===========================================
// INVOICE SYSTEM (Phase 5)
// ===========================================

// Final Invoice for claim
model ClaimInvoice {
  id          Int  @id @default(autoincrement())
  tenantId    Int
  claimId     Int  @unique
  quotationId Int? @unique

  invoiceNumber String   @db.VarChar(100)
  invoiceDate   DateTime @default(now())

  status InvoiceStatus @default(DRAFT)

  // Customer details (snapshot at invoice time)
  customerName    String  @db.VarChar(255)
  customerPhone   String  @db.VarChar(50)
  customerEmail   String? @db.VarChar(255)
  customerAddress String? @db.Text

  // Amounts
  subtotal       Decimal       @db.Decimal(12, 2)
  taxRate        Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount      Decimal       @default(0) @db.Decimal(12, 2)
  discountType   DiscountType?
  discountValue  Decimal       @default(0) @db.Decimal(12, 2)
  discountAmount Decimal       @default(0) @db.Decimal(12, 2)
  totalAmount    Decimal       @db.Decimal(12, 2)

  // Warranty covered items total (for reference)
  warrantyCoveredAmount Decimal @default(0) @db.Decimal(12, 2)

  // Payment tracking
  paidAmount       Decimal       @default(0) @db.Decimal(12, 2)
  paymentStatus    PaymentStatus @default(UNPAID)
  paymentMethod    String?       @db.VarChar(50)
  paymentReference String?       @db.VarChar(255)
  paidAt           DateTime?

  // Delivery readiness
  isReadyForDelivery Boolean @default(false)

  notes              String? @db.Text
  termsAndConditions String? @db.Text

  pdfUrl String? @db.VarChar(500)

  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim         WarrantyClaim   @relation(fields: [claimId], references: [id], onDelete: Cascade)
  quotation     ClaimQuotation? @relation(fields: [quotationId], references: [id], onDelete: SetNull)
  createdByUser User            @relation(fields: [createdBy], references: [id])
  items         InvoiceItem[]

  @@unique([tenantId, invoiceNumber])
  @@map("claim_invoices")
}

enum InvoiceStatus {
  DRAFT
  GENERATED
  SENT
  PAID
  PARTIALLY_PAID
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

// Invoice line items
model InvoiceItem {
  id        Int @id @default(autoincrement())
  invoiceId Int

  itemType InvoiceItemType

  // Reference to source
  claimPartId          Int?
  claimServiceChargeId Int?

  name        String  @db.VarChar(255)
  description String? @db.Text
  sku         String? @db.VarChar(100)

  quantity   Decimal @db.Decimal(10, 2)
  unitPrice  Decimal @db.Decimal(12, 2)
  totalPrice Decimal @db.Decimal(12, 2)

  isWarrantyCovered Boolean @default(false)

  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  invoice            ClaimInvoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  claimPart          ClaimPart?          @relation(fields: [claimPartId], references: [id], onDelete: SetNull)
  claimServiceCharge ClaimServiceCharge? @relation(fields: [claimServiceChargeId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@map("invoice_items")
}

enum InvoiceItemType {
  PART
  SERVICE
  LABOR
  OTHER
}
